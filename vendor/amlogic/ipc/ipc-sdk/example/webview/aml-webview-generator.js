function _instanceof(a,b){return null!=b&&"undefined"!==typeof Symbol&&b[Symbol.hasInstance]?!!b[Symbol.hasInstance](a):a instanceof b}function _classCallCheck(a,b){if(!_instanceof(a,b))throw new TypeError("Cannot call a class as a function");}function _defineProperties(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1;d.configurable=!0;"value"in d&&(d.writable=!0);Object.defineProperty(a,d.key,d)}}
function _createClass(a,b,c){b&&_defineProperties(a.prototype,b);c&&_defineProperties(a,c);return a}
var UINT32_MAX=Math.pow(2,32)-1,MP4=function(){function a(){_classCallCheck(this,a)}_createClass(a,null,[{key:"init",value:function(){a.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};for(var b in a.types)a.types.hasOwnProperty(b)&&(a.types[b]=[b.charCodeAt(0),
b.charCodeAt(1),b.charCodeAt(2),b.charCodeAt(3)]);b=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]);var c=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);a.HDLR_TYPES={video:b,audio:c};b=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]);c=new Uint8Array([0,0,0,0,0,0,0,0]);a.STTS=a.STSC=a.STCO=c;a.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,
0,0]);a.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]);a.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]);a.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);c=new Uint8Array([105,115,111,109]);var d=new Uint8Array([97,118,99,49]),e=new Uint8Array([0,0,0,1]);a.FTYP=a.box(a.types.ftyp,c,e,c,d);a.DINF=a.box(a.types.dinf,a.box(a.types.dref,b))}},{key:"box",value:function(a){for(var b=Array.prototype.slice.call(arguments,1),d=8,e=b.length,f=e,g;e--;)d+=b[e].byteLength;g=new Uint8Array(d);g[0]=d>>24&255;g[1]=d>>16&255;g[2]=
d>>8&255;g[3]=d&255;g.set(a,4);e=0;for(d=8;e<f;e++)g.set(b[e],d),d+=b[e].byteLength;return g}},{key:"hdlr",value:function(b){return a.box(a.types.hdlr,a.HDLR_TYPES[b])}},{key:"mdat",value:function(b){return a.box(a.types.mdat,b)}},{key:"mdhd",value:function(b,c){c*=b;var d=0>c?UINT32_MAX:Math.floor(c/(UINT32_MAX+1));c=0>c?UINT32_MAX:Math.floor(c%(UINT32_MAX+1));return a.box(a.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,b>>24&255,b>>16&255,b>>8&255,b&255,d>>24,d>>16&255,d>>8&
255,d&255,c>>24,c>>16&255,c>>8&255,c&255,85,196,0,0]))}},{key:"mdia",value:function(b){return a.box(a.types.mdia,a.mdhd(b.timescale,b.duration),a.hdlr(b.type),a.minf(b))}},{key:"mfhd",value:function(b){return a.box(a.types.mfhd,new Uint8Array([0,0,0,0,b>>24,b>>16&255,b>>8&255,b&255]))}},{key:"minf",value:function(b){return"audio"===b.type?a.box(a.types.minf,a.box(a.types.smhd,a.SMHD),a.DINF,a.stbl(b)):a.box(a.types.minf,a.box(a.types.vmhd,a.VMHD),a.DINF,a.stbl(b))}},{key:"moof",value:function(b,c,
d){return a.box(a.types.moof,a.mfhd(b),a.traf(d,c))}},{key:"moov",value:function(b){for(var c=b.length,d=[];c--;)d[c]=a.trak(b[c]);return a.box.apply(null,[a.types.moov,a.mvhd(b[0].timescale,b[0].duration)].concat(d).concat(a.mvex(b)))}},{key:"mvex",value:function(b){for(var c=b.length,d=[];c--;)d[c]=a.trex(b[c]);return a.box.apply(null,[a.types.mvex].concat(d))}},{key:"mvhd",value:function(b,c){c*=b;var d=0>c?UINT32_MAX:Math.floor(c/(UINT32_MAX+1));c=0>c?UINT32_MAX:Math.floor(c%(UINT32_MAX+1));b=
new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,b>>24&255,b>>16&255,b>>8&255,b&255,d>>24,d>>16&255,d>>8&255,d&255,c>>24,c>>16&255,c>>8&255,c&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return a.box(a.types.mvhd,b)}},{key:"sdtp",value:function(b){b=b.samples||[];var c=new Uint8Array(4+b.length),d;for(d=0;d<b.length;d++){var e=b[d].flags;c[d+4]=e.dependsOn<<4|e.isDependedOn<<
2|e.hasRedundancy}return a.box(a.types.sdtp,c)}},{key:"stbl",value:function(b){return a.box(a.types.stbl,a.stsd(b),a.box(a.types.stts,a.STTS),a.box(a.types.stsc,a.STSC),a.box(a.types.stsz,a.STSZ),a.box(a.types.stco,a.STCO))}},{key:"avc1",value:function(b){var c=[],d=[],e;for(e=0;e<b.sps.length;e++){var f=b.sps[e],g=f.byteLength;c.push(g>>>8&255);c.push(g&255);c=c.concat(Array.prototype.slice.call(f))}for(e=0;e<b.pps.length;e++)f=b.pps[e],g=f.byteLength,d.push(g>>>8&255),d.push(g&255),d=d.concat(Array.prototype.slice.call(f));
c=a.box(a.types.avcC,new Uint8Array([1,c[3],c[4],c[5],255,224|b.sps.length].concat(c).concat([b.pps.length]).concat(d)));d=b.width;e=b.height;f=b.pixelRatio[0];b=b.pixelRatio[1];return a.box(a.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,d>>8&255,d&255,e>>8&255,e&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),c,a.box(a.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,
0,45,198,192])),a.box(a.types.pasp,new Uint8Array([f>>24,f>>16&255,f>>8&255,f&255,b>>24,b>>16&255,b>>8&255,b&255])))}},{key:"esds",value:function(b){var a=b.config.length;return new Uint8Array([0,0,0,0,3,23+a,0,1,0,4,15+a,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([a]).concat(b.config).concat([6,1,2]))}},{key:"mp4a",value:function(b){var c=b.samplerate;return a.box(a.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,b.channelCount,0,16,0,0,0,0,c>>8&255,c&255,0,0]),a.box(a.types.esds,a.esds(b)))}},
{key:"mp3",value:function(b){var c=b.samplerate;return a.box(a.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,b.channelCount,0,16,0,0,0,0,c>>8&255,c&255,0,0]))}},{key:"stsd",value:function(b){return"audio"===b.type?b.isAAC||"mp3"!==b.codec?a.box(a.types.stsd,a.STSD,a.mp4a(b)):a.box(a.types.stsd,a.STSD,a.mp3(b)):a.box(a.types.stsd,a.STSD,a.avc1(b))}},{key:"tkhd",value:function(b){var c=b.id,d=b.duration*b.timescale,e=b.width;b=b.height;var f=0>d?UINT32_MAX:Math.floor(d/(UINT32_MAX+
1));d=0>d?UINT32_MAX:Math.floor(d%(UINT32_MAX+1));return a.box(a.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,c>>24&255,c>>16&255,c>>8&255,c&255,0,0,0,0,f>>24,f>>16&255,f>>8&255,f&255,d>>24,d>>16&255,d>>8&255,d&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,e>>8&255,e&255,0,0,b>>8&255,b&255,0,0]))}},{key:"traf",value:function(b,c){var d=a.sdtp(b),e=b.id,f=Math.floor(c/(UINT32_MAX+1));c=Math.floor(c%(UINT32_MAX+1));
return a.box(a.types.traf,a.box(a.types.tfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255])),a.box(a.types.tfdt,new Uint8Array([1,0,0,0,f>>24,f>>16&255,f>>8&255,f&255,c>>24,c>>16&255,c>>8&255,c&255])),a.trun(b,d.length+16+20+8+16+8+8),d)}},{key:"trak",value:function(b){b.duration=b.duration||4294967295;return a.box(a.types.trak,a.tkhd(b),a.mdia(b))}},{key:"trex",value:function(b){b=b.id;return a.box(a.types.trex,new Uint8Array([0,0,0,0,b>>24,b>>16&255,b>>8&255,b&255,0,0,0,1,0,0,0,0,0,0,
0,0,0,1,0,1]))}},{key:"trun",value:function(b,c){b=b.samples||[];var d=b.length,e=12+16*d,f=new Uint8Array(e);c+=8+e;f.set([0,0,15,1,d>>>24&255,d>>>16&255,d>>>8&255,d&255,c>>>24&255,c>>>16&255,c>>>8&255,c&255],0);for(c=0;c<d;c++){var g=b[c];e=g.duration;var k=g.size,h=g.flags;g=g.cts;f.set([e>>>24&255,e>>>16&255,e>>>8&255,e&255,k>>>24&255,k>>>16&255,k>>>8&255,k&255,h.isLeading<<2|h.dependsOn,h.isDependedOn<<6|h.hasRedundancy<<4|h.paddingValue<<1|h.isNonSync,h.degradPrio&61440,h.degradPrio&15,g>>>
24&255,g>>>16&255,g>>>8&255,g&255],12+16*c)}return a.box(a.types.trun,f)}},{key:"initSegment",value:function(b){a.types||a.init();b=a.moov(b);var c=new Uint8Array(a.FTYP.byteLength+b.byteLength);c.set(a.FTYP);c.set(b,a.FTYP.byteLength);return c}}]);return a}();
